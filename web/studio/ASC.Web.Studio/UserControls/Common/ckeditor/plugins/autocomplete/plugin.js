/**
 * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
(function(){function n(n,t){var i=n.config.autocomplete_commitKeystrokes||CKEDITOR.config.autocomplete_commitKeystrokes;if(this.editor=n,this.throttle=t.throttle!==undefined?t.throttle:20,this.view=this.getView(),this.model=this.getModel(t.dataCallback),this.model.itemsLimit=t.itemsLimit,this.textWatcher=this.getTextWatcher(t.textTestCallback),this.commitKeystrokes=CKEDITOR.tools.array.isArray(i)?i.slice():[i],this._listeners=[],this.outputTemplate=t.outputTemplate!==undefined?new CKEDITOR.template(t.outputTemplate):null,t.itemTemplate&&(this.view.itemTemplate=new CKEDITOR.template(t.itemTemplate)),this.editor.status==="ready")this.attach();else this.editor.on("instanceReady",function(){this.attach()},this);n.on("destroy",function(){this.destroy()},this)}function t(n){this.itemTemplate=new CKEDITOR.template('<li data-id="{id}">{name}<\/li>');this.editor=n}function i(n){this.dataCallback=n;this.isActive=!1;this.itemsLimit=0}function r(n){return n.window.getFrame().getParent()}function u(n){return CKEDITOR.tools.array.reduce(CKEDITOR.tools.object.keys(n),function(t,i){return t[i]=CKEDITOR.tools.htmlEncode(n[i]),t},{})}CKEDITOR.plugins.add("autocomplete",{requires:"textwatcher",onLoad:function(){CKEDITOR.document.appendStyleSheet(this.path+"skins/default.css")},isSupportedEnvironment:function(){return!CKEDITOR.env.ie||CKEDITOR.env.version>8}});n.prototype={attach:function(){var t=this.editor,u=CKEDITOR.document.getWindow(),n=t.editable(),i=n.isInline()?n:n.getDocument();CKEDITOR.env.iOS&&!n.isInline()&&(i=r(t));this.view.append();this.view.attach();this.textWatcher.attach();this._listeners.push(this.textWatcher.on("matched",this.onTextMatched,this));this._listeners.push(this.textWatcher.on("unmatched",this.onTextUnmatched,this));this._listeners.push(this.model.on("change-data",this.modelChangeListener,this));this._listeners.push(this.model.on("change-selectedItemId",this.onSelectedItemId,this));this._listeners.push(this.view.on("change-selectedItemId",this.onSelectedItemId,this));this._listeners.push(this.view.on("click-item",this.onItemClick,this));this._listeners.push(this.model.on("change-isActive",this.updateAriaAttributesOnEditable,this));this._listeners.push(u.on("scroll",function(){this.viewRepositionListener()},this));this._listeners.push(i.on("scroll",function(){this.viewRepositionListener()},this));this._listeners.push(this.view.element.on("mousedown",function(n){n.data.preventDefault()},null,null,9999));n&&(this.registerPanelNavigation(),this.addAriaAttributesToEditable());t.on("contentDom",function(){this.registerPanelNavigation();this.addAriaAttributesToEditable()},this)},registerPanelNavigation:function(){var n=this.editor.editable();this._listeners.push(n.attachListener(n,"keydown",function(n){this.onKeyDown(n)},this,null,5))},addAriaAttributesToEditable:function(){var n=this.editor.editable(),t=this.view.element.getAttribute("id");n.isInline()&&(n.setAttribute("aria-controls",t),n.setAttribute("aria-activedescendant",""),n.setAttribute("aria-autocomplete","list"),n.setAttribute("aria-expanded","false"))},updateAriaAttributesOnEditable:function(n){var t=this.editor.editable(),i=n.data;t&&t.isInline()&&(t.setAttribute("aria-expanded",i?"true":"false"),i||t.setAttribute("aria-activedescendant",""))},updateAriaActiveDescendantAttributeOnEditable:function(n){var t=this.editor.editable();t.isInline()&&t.setAttribute("aria-activedescendant",n)},removeAriaAttributesFromEditable:function(){var n=this.editor.editable();n&&n.isInline()&&(n.removeAttributes(["aria-controls","aria-expanded","aria-activedescendant"]),n.setAttribute("aria-autocomplete","none"))},close:function(){this.model.setActive(!1);this.view.close()},commit:function(n){if(this.model.isActive&&(this.close(),n!=null||(n=this.model.selectedItemId,n!=null))){var i=this.model.getItemById(n),t=this.editor;t.fire("saveSnapshot");t.getSelection().selectRanges([this.model.range]);t.insertHtml(this.getHtmlToInsert(i),"text");t.fire("saveSnapshot");t.fire("autocompleteCommit",n)}},destroy:function(){CKEDITOR.tools.array.forEach(this._listeners,function(n){n.removeListener()});this._listeners=[];this.view.element&&this.view.element.remove();this.removeAriaAttributesFromEditable()},getHtmlToInsert:function(n){var t=u(n);return this.outputTemplate?this.outputTemplate.output(t):t.name},getModel:function(n){var t=this;return new i(function(i,r){return n.call(this,CKEDITOR.tools.extend({autocomplete:t},i),r)})},getTextWatcher:function(n){return new CKEDITOR.plugins.textWatcher(this.editor,n,this.throttle)},getView:function(){return new t(this.editor)},open:function(){this.model.hasData()&&(this.model.setActive(!0),this.view.open(),this.model.selectFirst(),this.view.updatePosition(this.model.range))},viewRepositionListener:function(){this.model.isActive&&this.view.updatePosition(this.model.range)},modelChangeListener:function(n){this.model.hasData()?(this.view.updateItems(n.data),this.open()):this.close()},onItemClick:function(n){this.commit(n.data)},onKeyDown:function(n){if(this.model.isActive){var i=n.data.getKey(),t=!1;i==27?(this.close(),this.textWatcher.unmatch(),t=!0):i==40?(this.model.selectNext(),t=!0):i==38?(this.model.selectPrevious(),t=!0):CKEDITOR.tools.indexOf(this.commitKeystrokes,i)!=-1&&(this.commit(),this.textWatcher.unmatch(),t=!0);t&&(n.cancel(),n.data.preventDefault(),this.textWatcher.consumeNext())}},onSelectedItemId:function(n){var t=n.data,i=this.view.getItemById(t);this.model.setItem(t);this.view.selectItem(t);this.updateAriaActiveDescendantAttributeOnEditable(i.getAttribute("id"))},onTextMatched:function(n){this.model.setActive(!1);this.model.setQuery(n.data.text,n.data.range)},onTextUnmatched:function(){this.model.query=null;this.model.lastRequestId=null;this.close()}};t.prototype={append:function(){this.document=CKEDITOR.document;this.element=this.createElement();this.document.getBody().append(this.element)},appendItems:function(n){this.element.setHtml("");this.element.append(n)},attach:function(){this.element.on("click",function(n){var i=n.data.getTarget(),t=i.getAscendant(this.isItemElement,!0);t&&this.fire("click-item",t.data("id"))},this);this.element.on("mouseover",function(n){var t=n.data.getTarget(),i;if(this.element.contains(t)){if(t=t.getAscendant(function(n){return n.hasAttribute("data-id")},!0),!t)return;i=t.data("id");this.fire("change-selectedItemId",i)}},this)},close:function(){this.element.removeClass("cke_autocomplete_opened")},createElement:function(){var n=new CKEDITOR.dom.element("ul",this.document),t=CKEDITOR.tools.getNextId();return n.setAttribute("id",t),n.addClass("cke_autocomplete_panel"),n.setStyle("z-index",this.editor.config.baseFloatZIndex-3),n.setAttribute("role","listbox"),n},createItem:function(n){var i=u(n),t=CKEDITOR.dom.element.createFromHtml(this.itemTemplate.output(i),this.document),r=CKEDITOR.tools.getNextId();return t.setAttribute("id",r),t.setAttribute("role","option"),t},getViewPosition:function(n){var f=n.getClientRects(),r=f[f.length-1],t,e=this.editor.editable(),i,u;return t=e.isInline()?CKEDITOR.document.getWindow().getScrollPosition():e.getParent().getDocumentPosition(CKEDITOR.document),i=CKEDITOR.document.getBody(),i.getComputedStyle("position")==="static"&&(i=i.getParent()),u=i.getDocumentPosition(),t.x-=u.x,t.y-=u.y,{top:r.top+t.y,bottom:r.top+r.height+t.y,left:r.left+t.x}},getItemById:function(n){return this.element.findOne('li[data-id="'+n+'"]')},isItemElement:function(n){return n.type==CKEDITOR.NODE_ELEMENT&&Boolean(n.data("id"))},open:function(){this.element.addClass("cke_autocomplete_opened")},selectItem:function(n){this.selectedItemId!=null&&this.getItemById(this.selectedItemId).removeClass("cke_autocomplete_selected");var t=this.getItemById(n);t.addClass("cke_autocomplete_selected");this.selectedItemId=n;this.scrollElementTo(t)},setPosition:function(n){function e(n){var r=n.editorViewportRect,t=n.caretRect,i=n.viewHeight,u=n.scrollPositionY,s=n.windowHeight,o;if(r.bottom<t.bottom)return Math.min(t.top,r.bottom)-i;var f=t.top-r.top,e=r.bottom-t.bottom,h=t.top-i<u;return i>e&&i<f&&!h?t.top-i:r.top>t.top?Math.max(t.bottom,r.top):(o=t.bottom+i>s+u,!(i>e&&i<f)&&o)?t.top-i:Math.min(r.bottom,t.bottom)}function o(n){var t=n.leftPosition,i=n.viewWidth,r=n.windowWidth;return t+i>r?r-i:t}function s(n){var t=n.editable();return CKEDITOR.env.iOS&&!t.isInline()?r(n).getClientRect(!0):t.isInline()?t.getClientRect(!0):n.window.getFrame().getClientRect(!0)}var t=this.element.getWindow(),i=t.getViewPaneSize(),u=e({editorViewportRect:s(this.editor),caretRect:n,viewHeight:this.element.getSize("height"),scrollPositionY:t.getScrollPosition().y,windowHeight:i.height}),f=o({leftPosition:n.left,viewWidth:this.element.getSize("width"),windowWidth:i.width});this.element.setStyles({left:f+"px",top:u+"px"})},scrollElementTo:function(n){n.scrollIntoParent(this.element)},updateItems:function(n){for(var i=new CKEDITOR.dom.documentFragment(this.document),t=0;t<n.length;++t)i.append(this.createItem(n[t]));this.appendItems(i);this.selectedItemId=null},updatePosition:function(n){this.setPosition(this.getViewPosition(n))}};CKEDITOR.event.implementOn(t.prototype);i.prototype={getIndexById:function(n){if(!this.hasData())return-1;for(var i=this.data,t=0,r=i.length;t<r;t++)if(i[t].id==n)return t;return-1},getItemById:function(n){var t=this.getIndexById(n);return~t&&this.data[t]||null},hasData:function(){return Boolean(this.data&&this.data.length)},setItem:function(n){if(this.getIndexById(n)<0)throw new Error("Item with given id does not exist");this.selectedItemId=n},select:function(n){this.fire("change-selectedItemId",n)},selectFirst:function(){this.hasData()&&this.select(this.data[0].id)},selectLast:function(){this.hasData()&&this.select(this.data[this.data.length-1].id)},selectNext:function(){if(this.selectedItemId==null){this.selectFirst();return}var n=this.getIndexById(this.selectedItemId);n<0||n+1==this.data.length?this.selectFirst():this.select(this.data[n+1].id)},selectPrevious:function(){if(this.selectedItemId==null){this.selectLast();return}var n=this.getIndexById(this.selectedItemId);n<=0?this.selectLast():this.select(this.data[n-1].id)},setActive:function(n){this.isActive=n;this.fire("change-isActive",n)},setQuery:function(n,t){function u(n){r==i.lastRequestId&&(i.data=i.itemsLimit?n.slice(0,i.itemsLimit):n,i.fire("change-data",i.data))}var i=this,r=CKEDITOR.tools.getNextId();this.lastRequestId=r;this.query=n;this.range=t;this.data=null;this.selectedItemId=null;this.dataCallback({query:n,range:t},u)}};CKEDITOR.event.implementOn(i.prototype);CKEDITOR.plugins.autocomplete=n;n.view=t;n.model=i;CKEDITOR.config.autocomplete_commitKeystrokes=[9,13]})()